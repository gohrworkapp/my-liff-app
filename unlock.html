<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GoHR - Unlock Mode</title>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #F0F4F8; 
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom Scrollbar hide */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #e0e7ff;
            border-top: 3px solid #4338ca; 
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Card Effects */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .btn-press:active { transform: scale(0.95); transition: transform 0.1s; }
    </style>
</head>
<body class="min-h-screen flex justify-center bg-slate-100">

    <div class="w-full max-w-md min-h-screen relative flex flex-col bg-white shadow-2xl overflow-hidden">
        
        <header class="relative bg-gradient-to-br from-blue-900 via-indigo-800 to-blue-600 text-white px-6 pt-12 pb-20 rounded-b-[40px] shadow-lg">
            <div class="absolute top-0 right-0 opacity-10 pointer-events-none">
                <i class="fas fa-map-marked-alt text-[180px] -mr-10 -mt-10 transform rotate-12"></i>
            </div>

            <div class="relative z-10 flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold tracking-wide flex items-center gap-2">
                        Go<span class="text-yellow-400">HR</span>
                    </h1>
                    <div class="mt-1 inline-flex items-center gap-1.5 bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm border border-white/10">
                        <i class="fas fa-globe-americas text-xs text-yellow-300"></i>
                        <span class="text-xs font-medium tracking-wide">Unlock Mode (Anywhere)</span>
                    </div>
                </div>
                
                <div id="profileSection" class="flex flex-col items-end opacity-0 transition-opacity duration-700">
                     <div class="p-0.5 bg-white/30 rounded-full mb-1">
                        <img id="userImage" src="https://via.placeholder.com/100" class="w-12 h-12 rounded-full border-2 border-white object-cover">
                     </div>
                     <p id="userName" class="font-medium text-xs text-blue-100 truncate max-w-[100px]">Loading...</p>
                </div>
            </div>
        </header>

        <main class="px-5 -mt-12 relative z-20 pb-24 flex-grow">
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="handleAction('‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')" class="btn-press glass-panel p-5 rounded-2xl flex flex-col items-center gap-3 shadow-sm hover:shadow-md transition-all group bg-white">
                    <div class="w-14 h-14 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 text-2xl shadow-inner group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-sign-in-alt pl-1"></i>
                    </div>
                    <span class="text-sm font-bold text-slate-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</span>
                </button>

                <button onclick="handleAction('‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Ñ')" class="btn-press glass-panel p-5 rounded-2xl flex flex-col items-center gap-3 shadow-sm hover:shadow-md transition-all group bg-white">
                    <div class="w-14 h-14 bg-amber-50 rounded-2xl flex items-center justify-center text-amber-500 text-2xl shadow-inner group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <span class="text-sm font-bold text-slate-700">‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Ñ</span>
                </button>

                <button onclick="handleAction('‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô')" class="btn-press glass-panel p-5 rounded-2xl flex flex-col items-center gap-3 shadow-sm hover:shadow-md transition-all group bg-white">
                    <div class="w-14 h-14 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 text-2xl shadow-inner group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-undo pr-1"></i>
                    </div>
                    <span class="text-sm font-bold text-slate-700">‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏≥</span>
                </button>

                <button onclick="openCheckoutModal()" class="btn-press glass-panel p-5 rounded-2xl flex flex-col items-center gap-3 shadow-sm hover:shadow-md transition-all group bg-white border-b-4 border-transparent hover:border-rose-500">
                    <div class="w-14 h-14 bg-rose-50 rounded-2xl flex items-center justify-center text-rose-500 text-2xl shadow-inner group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-sign-out-alt pl-1"></i>
                    </div>
                    <span class="text-sm font-bold text-slate-700">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</span>
                </button>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-lg border border-slate-100">
                <div class="flex justify-between items-center mb-5 pb-3 border-b border-slate-100">
                    <h3 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                        <i class="fas fa-history text-indigo-600"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                    </h3>
                    <button onclick="fetchHistory()" class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full hover:bg-indigo-100 transition-colors flex items-center gap-1 active:scale-95">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div id="historyList" class="space-y-3 max-h-[220px] overflow-y-auto pr-1 scrollbar-hide">
                    <div class="text-center py-6 text-slate-400 text-sm flex flex-col items-center gap-2">
                        <i class="fas fa-circle-notch fa-spin text-indigo-300"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                    </div>
                </div>
            </div>
        </main>

        <footer class="absolute bottom-4 w-full text-center">
            <p class="text-[10px] text-slate-300 font-light">GoHR Unlock System v2.0</p>
        </footer>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex-col items-center justify-center">
        <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center transform scale-100 animate-bounce-slow">
            <div class="spinner mb-4"></div>
            <p class="text-sm font-bold text-slate-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            <p class="text-xs text-slate-400 mt-1">Unlock Mode Active</p>
        </div>
    </div>

    <div id="checkoutModal" class="fixed inset-0 bg-slate-900/70 z-50 hidden items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white w-full max-w-sm rounded-t-[30px] sm:rounded-3xl shadow-2xl overflow-hidden transform translate-y-full sm:scale-95 sm:translate-y-0 transition-all duration-300">
            <div class="bg-rose-600 px-6 py-5 flex justify-between items-center text-white">
                 <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fas fa-clipboard-check"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô
                </h3>
                <button onclick="closeCheckoutModal()" class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/30 transition">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div class="p-6 bg-slate-50">
                <label class="block text-sm font-bold text-slate-700 mb-2">
                    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ <span class="text-rose-500">*</span>
                </label>
                <textarea id="workDescInput" class="w-full bg-white border border-slate-200 rounded-xl p-4 text-sm focus:ring-2 focus:ring-rose-200 focus:border-rose-400 focus:outline-none h-32 resize-none placeholder-slate-400 shadow-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ, ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô..."></textarea>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="closeCheckoutModal()" class="flex-1 py-3.5 bg-white border border-slate-200 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-50 transition shadow-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="confirmCheckout()" class="flex-1 py-3.5 bg-rose-600 text-white rounded-xl text-sm font-bold hover:bg-rose-700 shadow-md shadow-rose-200 transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURATION (‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
        // ==========================================
        const CONFIG = {
            LIFF_ID: "2008786300-hy6x4jOO", // ‚ö†Ô∏è ‡πÉ‡∏™‡πà ID LIFF ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2 (Unlock)
            GAS_URL: "https://script.google.com/macros/s/AKfycbz_Y16nhIrirD5rqt5Czkz0ROea94AUifSaW7DiTy_5ncZBX5Z3pk8bB9GeB56ruBLw6Q/exec"   // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL Web App ‡∏ó‡∏µ‡πà Deploy ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        };
        // ==========================================

        let USER_PROFILE = null;

        // 1. Initial Logic
        async function main() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return; 
                }
                USER_PROFILE = await liff.getProfile();
                updateUI(USER_PROFILE);
                fetchHistory(); // ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
            } catch (err) { 
                console.error("LIFF Error:", err);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function updateUI(profile) {
            document.getElementById('userImage').src = profile.pictureUrl;
            document.getElementById('userName').innerText = profile.displayName;
            document.getElementById('profileSection').classList.remove('opacity-0');
        }

        // 2. Main Action Handler (The Unlock Logic)
        async function handleAction(type, note = "-") {
            toggleLoading(true);
            try {
                // ‡∏î‡∏∂‡∏á GPS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡πÅ‡∏ï‡πà Backend ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞)
                const userLoc = await getGPS(); 
                
                // Construct Payload
                const payload = {
                    action: 'submit_checkin',
                    userId: USER_PROFILE.userId,
                    displayName: USER_PROFILE.displayName,
                    pictureUrl: USER_PROFILE.pictureUrl,
                    type: type,
                    lat: userLoc.lat,
                    lng: userLoc.lng,
                    note: note,
                    // üîë KEY FIX: ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Backend ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Unlock Mode
                    locationName: "Unlock Mode", 
                    distance: 0 
                };

                const result = await sendToGAS(payload);
                
                toggleLoading(false);
                
                // Show Success
                await Swal.fire({
                    icon: 'success',
                    title: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${type} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,
                    text: `(Unlock Mode) ‡πÄ‡∏ß‡∏•‡∏≤: ${result.time}`,
                    confirmButtonColor: '#304FFE',
                    timer: 2000
                });
                
                fetchHistory();

            } catch (err) {
                toggleLoading(false);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ',
                    confirmButtonColor: '#d33'
                });
            }
        }

        // 3. Network & Data Logic
        async function sendToGAS(payload) {
            // ‡πÉ‡∏ä‡πâ fetch POST ‡∏õ‡∏Å‡∏ï‡∏¥ (GAS ‡∏ï‡πâ‡∏≠‡∏á Deploy ‡πÄ‡∏õ‡πá‡∏ô 'Anyone')
            const response = await fetch(CONFIG.GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            
            // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Text ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô Error HTML
            const text = await response.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                console.error("Parse Error:", text);
                throw new Error("Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (Parse Error)");
            }

            if (data.status === 'error') {
                throw new Error(data.message);
            }
            return data;
        }

        async function fetchHistory() {
            const list = document.getElementById('historyList');
            // Show loading skeleton if empty
            if(list.children.length === 0 || list.innerHTML.includes('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')) {
                list.innerHTML = `<div class="text-center py-6 text-slate-400 text-sm flex flex-col items-center gap-2"><i class="fas fa-circle-notch fa-spin text-indigo-300"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;
            }

            try {
                // ‡πÉ‡∏ä‡πâ POST ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå (‡∏ö‡∏≤‡∏á‡∏ó‡∏µ GET ‡∏ï‡∏¥‡∏î Cache/CORS)
                const res = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_today_history', userId: USER_PROFILE.userId })
                });
                const json = await res.json();
                renderHistory(json.data);
            } catch (err) {
                console.warn("History Error:", err);
                list.innerHTML = `<div class="text-center py-4 text-red-400 text-xs">‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
            }
        }

        function renderHistory(logs) {
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            
            if (!logs || logs.length === 0) {
                list.innerHTML = `<div class="text-center py-8 text-slate-300 text-sm">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
                return;
            }

            logs.forEach(log => {
                let colorClass = "text-slate-600";
                let icon = "fa-clock";
                let bgIcon = "bg-slate-100";

                if (log.action.includes("‡πÄ‡∏Ç‡πâ‡∏≤")) { colorClass = "text-emerald-600"; icon = "fa-sign-in-alt"; bgIcon = "bg-emerald-50"; }
                else if (log.action.includes("‡∏≠‡∏≠‡∏Å")) { colorClass = "text-rose-600"; icon = "fa-sign-out-alt"; bgIcon = "bg-rose-50"; }
                else if (log.action.includes("‡πÄ‡∏ö‡∏£‡∏Ñ")) { colorClass = "text-amber-500"; icon = "fa-utensils"; bgIcon = "bg-amber-50"; }
                else if (log.action.includes("‡∏Å‡∏•‡∏±‡∏ö")) { colorClass = "text-blue-600"; icon = "fa-undo"; bgIcon = "bg-blue-50"; }

                list.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${bgIcon} flex items-center justify-center ${colorClass}">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold ${colorClass}">${log.action}</p>
                                <p class="text-[10px] text-slate-400">Unlock Mode</p>
                            </div>
                        </div>
                        <span class="text-sm font-mono font-bold text-slate-600 bg-slate-50 px-2 py-1 rounded-md border border-slate-100">${log.time}</span>
                    </div>`;
            });
        }

        // 4. Utilities & Modal
        function getGPS() {
            return new Promise((resolve) => {
                if(!navigator.geolocation) resolve({lat:0, lng:0});
                navigator.geolocation.getCurrentPosition(
                    pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                    err => { console.warn("GPS Fail:", err); resolve({ lat:0, lng:0 }); },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        }

        function toggleLoading(show) {
            const el = document.getElementById('loadingOverlay');
            show ? (el.classList.remove('hidden'), el.classList.add('flex')) : (el.classList.add('hidden'), el.classList.remove('flex'));
        }

        // Modal Controls
        const modal = document.getElementById('checkoutModal');
        function openCheckoutModal() { 
            modal.classList.remove('hidden'); 
            modal.classList.add('flex'); 
            setTimeout(() => modal.classList.remove('opacity-0'), 10); // Fade in
            document.getElementById('checkoutModal').querySelector('div').classList.remove('translate-y-full'); // Slide up
        }
        function closeCheckoutModal() { 
            modal.classList.add('opacity-0'); 
            document.getElementById('checkoutModal').querySelector('div').classList.add('translate-y-full');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300); 
        }
        function confirmCheckout() {
            const note = document.getElementById('workDescInput').value.trim();
            if (!note) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'warning');
                return;
            }
            closeCheckoutModal();
            handleAction('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô', note);
            document.getElementById('workDescInput').value = ""; // Clear input
        }

        // Run
        main();
    </script>
</body>
</html>
