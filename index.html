<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GoHR - ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</title>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #F1F5F9; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }
        .loader { width: 30px; height: 30px; border: 3px solid #E2E8F0; border-top: 3px solid #3B82F6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <div class="relative bg-gradient-to-r from-blue-600 to-indigo-700 pb-12 pt-8 px-6 rounded-b-[35px] shadow-lg overflow-hidden">
        <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
        
        <div id="profileSection" class="relative z-10 flex flex-col items-center opacity-0 transition-opacity duration-500">
            <img id="userImage" src="https://via.placeholder.com/150" class="w-20 h-20 rounded-full border-4 border-white/30 shadow-md object-cover">
            <h1 id="userName" class="text-white text-lg font-bold mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h1>
            <div class="flex items-center gap-2 mt-1">
                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                <span class="text-blue-100 text-xs">‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            </div>
        </div>
    </div>

    <div class="px-5 -mt-8 flex-grow pb-24 z-20">
        
        <div class="glass-card p-6 mb-5">
            <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4 ml-1">‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>
            
            <div class="grid grid-cols-2 gap-3">
                
                <button onclick="handleAction('‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')" class="btn-press bg-emerald-50 border border-emerald-100 p-4 rounded-xl flex flex-col items-center justify-center gap-2">
                    <div class="w-10 h-10 bg-emerald-500 text-white rounded-full flex items-center justify-center text-lg shadow-md shadow-emerald-200">
                        <i class="fas fa-sign-in-alt"></i>
                    </div>
                    <span class="text-emerald-700 font-medium text-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</span>
                </button>

                <button onclick="handleAction('‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Ñ')" class="btn-press bg-amber-50 border border-amber-100 p-4 rounded-xl flex flex-col items-center justify-center gap-2">
                    <div class="w-10 h-10 bg-amber-400 text-white rounded-full flex items-center justify-center text-lg shadow-md shadow-amber-200">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <span class="text-amber-700 font-medium text-sm">‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Ñ</span>
                </button>

                <button onclick="handleAction('‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô')" class="btn-press bg-blue-50 border border-blue-100 p-4 rounded-xl flex flex-col items-center justify-center gap-2">
                    <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center text-lg shadow-md shadow-blue-200">
                        <i class="fas fa-undo"></i>
                    </div>
                    <span class="text-blue-700 font-medium text-sm">‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏≥</span>
                </button>

                <button onclick="openCheckoutModal()" class="btn-press bg-rose-50 border border-rose-100 p-4 rounded-xl flex flex-col items-center justify-center gap-2">
                    <div class="w-10 h-10 bg-rose-500 text-white rounded-full flex items-center justify-center text-lg shadow-md shadow-rose-200">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <span class="text-rose-700 font-medium text-sm">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</span>
                </button>

            </div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                    <i class="fas fa-history text-indigo-500"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                </h3>
                <button onclick="fetchHistory()" class="text-xs text-indigo-500 hover:underline">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <div id="historyList" class="space-y-2">
                <div class="text-center py-4 text-slate-400 text-xs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-50 hidden flex-col items-center justify-center">
        <div class="loader mb-3"></div>
        <p class="text-slate-600 text-sm font-medium animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>

    <div id="checkoutModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden items-center justify-center px-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white w-full max-w-xs rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="bg-rose-500 p-4 text-white text-center">
                <h3 class="font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h3>
            </div>
            <div class="p-5">
                <p class="text-xs text-slate-500 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</p>
                <textarea id="workDescInput" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-rose-400 focus:outline-none h-24 resize-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ, ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"></textarea>
                <div class="flex gap-2 mt-4">
                    <button onclick="closeCheckoutModal()" class="flex-1 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="confirmCheckout()" class="flex-1 py-2 bg-rose-500 text-white rounded-lg text-sm font-medium shadow-lg shadow-rose-200">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Config ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤
        const CONFIG = {
            LIFF_ID: "2008786300-Zxf736Ka", 
            GAS_URL: "https://script.google.com/macros/s/AKfycbztThBYPFBGw1gKYl6-EsAUSr0z3fQ71S_wcsqWqVCiY3Pq7DAClfBYU0Ec4qWxH3YG9Q/exec"
        };

        let USER_PROFILE = null;
        let OFFICE_LOCATIONS = [];

        // --- System Start ---
        async function main() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                USER_PROFILE = await liff.getProfile();
                updateUI(USER_PROFILE);
                
                await Promise.all([
                    fetchHistory(),
                    fetchOfficeLocations()
                ]);

            } catch (err) {
                console.error(err);
            }
        }

        function updateUI(profile) {
            document.getElementById('userImage').src = profile.pictureUrl;
            document.getElementById('userName').innerText = profile.displayName;
            document.getElementById('profileSection').classList.remove('opacity-0');
        }

        // --- Load Office ---
        async function fetchOfficeLocations() {
            try {
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_office_locations' })
                });
                const result = await response.json();
                OFFICE_LOCATIONS = result.data || [];
                console.log("Office Loaded:", OFFICE_LOCATIONS.length);
            } catch (err) {
                console.warn("Location Load Error:", err);
            }
        }

        // --- Main Logic ---
        async function handleAction(type, note = "-") {
            toggleLoading(true);
            
            try {
                // 1. GPS
                const userLoc = await getGPS();
                if (userLoc.lat === 0 && userLoc.lng === 0) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Location ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠");
                }

                // 2. Check Data
                if (OFFICE_LOCATIONS.length === 0) {
                    await fetchOfficeLocations();
                    if (OFFICE_LOCATIONS.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin)");
                }

                // 3. Distance Check
                let matchedLocation = null;
                let minDistance = Infinity;

                OFFICE_LOCATIONS.forEach(office => {
                    const officeLat = parseFloat(office.lat);
                    const officeLng = parseFloat(office.lng);
                    const officeRadius = parseFloat(office.radius) || 500;

                    const dist = calculateDistance(userLoc.lat, userLoc.lng, officeLat, officeLng);
                    
                    if (dist <= officeRadius && dist < minDistance) {
                        minDistance = dist;
                        matchedLocation = office;
                    }
                });

                if (!matchedLocation) {
                    throw new Error(`‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏´‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î ${Math.round(minDistance)} ‡∏°.)`);
                }

                // 4. Send Data
                const payload = {
                    action: 'submit_checkin',
                    userId: USER_PROFILE.userId,
                    displayName: USER_PROFILE.displayName,
                    pictureUrl: USER_PROFILE.pictureUrl,
                    type: type,
                    lat: userLoc.lat,
                    lng: userLoc.lng,
                    note: note,
                    locationName: matchedLocation.name,
                    distance: Math.round(minDistance)
                };

                await sendToGAS(payload);

                toggleLoading(false);
                alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "${type}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\nüìç ${matchedLocation.name}`);
                
                fetchHistory();

            } catch (err) {
                toggleLoading(false);
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            }
        }

        // --- History ---
        async function fetchHistory() {
            const list = document.getElementById('historyList');
            try {
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_today_history', userId: USER_PROFILE.userId })
                });
                const res = await response.json();
                renderHistory(res.data);
            } catch (err) {
                console.error(err);
                list.innerHTML = `<div class="text-center text-xs text-rose-400">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>`;
            }
        }

        function renderHistory(logs) {
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            if (!logs || logs.length === 0) {
                list.innerHTML = `<div class="text-center py-4 text-slate-300 text-xs">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>`;
                return;
            }
            logs.forEach(log => {
                let color = "bg-slate-500";
                if(log.action.includes("‡πÄ‡∏Ç‡πâ‡∏≤")) color = "bg-emerald-500";
                else if(log.action.includes("‡∏≠‡∏≠‡∏Å")) color = "bg-rose-500";
                else if(log.action.includes("‡∏û‡∏±‡∏Å")) color = "bg-amber-400";
                else color = "bg-blue-500";

                list.innerHTML += `
                    <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full ${color}"></div>
                            <span class="text-sm text-slate-600 font-medium">${log.action}</span>
                        </div>
                        <span class="text-xs font-mono text-slate-400">${log.time} ‡∏ô.</span>
                    </div>`;
            });
        }

        // --- Helpers ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function getGPS() {
            return new Promise((resolve) => {
                if(!navigator.geolocation) resolve({lat:0, lng:0});
                navigator.geolocation.getCurrentPosition(
                    pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                    () => resolve({ lat:0, lng:0 }),
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        }

        async function sendToGAS(payload) {
            return fetch(CONFIG.GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
        }

        function toggleLoading(show) {
            const el = document.getElementById('loadingOverlay');
            if(show) { el.classList.remove('hidden'); el.classList.add('flex'); }
            else { el.classList.add('hidden'); el.classList.remove('flex'); }
        }

        // Modal Logic
        const modal = document.getElementById('checkoutModal');
        const modalBox = modal.querySelector('div');
        function openCheckoutModal() {
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => { modal.classList.remove('opacity-0'); modalBox.classList.remove('scale-95'); }, 10);
        }
        function closeCheckoutModal() {
            modal.classList.add('opacity-0'); modalBox.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
        }
        function confirmCheckout() {
            const note = document.getElementById('workDescInput').value.trim();
            if(!note) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô"); return; }
            closeCheckoutModal();
            handleAction('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô', note);
            document.getElementById('workDescInput').value = "";
        }

        main();
    </script>
</body>
</html>
