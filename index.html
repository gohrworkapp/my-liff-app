<!DOCTYPE html>
<html lang="th">
<head>
┬а ┬а <meta charset="UTF-8">
┬а ┬а <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
┬а ┬а <title>GoHR - р╕ер╕Зр╣Ар╕зр╕ер╕▓р╕Чр╕│р╕Зр╕▓р╕Щ</title>
┬а ┬а┬а
┬а ┬а <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
┬а ┬а <script src="https://cdn.tailwindcss.com"></script>
┬а ┬а <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
┬а ┬а <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

┬а ┬а <style>
┬а ┬а ┬а ┬а body { font-family: 'Kanit', sans-serif; background-color: #F1F5F9; -webkit-tap-highlight-color: transparent; }
┬а ┬а ┬а ┬а .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
┬а ┬а ┬а ┬а .btn-press { transition: transform 0.1s; }
┬а ┬а ┬а ┬а .btn-press:active { transform: scale(0.95); }
┬а ┬а ┬а ┬а .loader { width: 30px; height: 30px; border: 3px solid #E2E8F0; border-top: 3px solid #3B82F6; border-radius: 50%; animation: spin 1s linear infinite; }
┬а ┬а ┬а ┬а @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
┬а ┬а </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

┬а ┬а <div class="relative bg-gradient-to-r from-blue-600 to-indigo-700 pb-12 pt-8 px-6 rounded-b-[35px] shadow-lg overflow-hidden">
┬а ┬а ┬а ┬а <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а <div id="profileSection" class="relative z-10 flex flex-col items-center opacity-0 transition-opacity duration-500">
┬а ┬а ┬а ┬а ┬а ┬а <img id="userImage" src="https://via.placeholder.com/150" class="w-20 h-20 rounded-full border-4 border-white/30 shadow-md object-cover">
┬а ┬а ┬а ┬а ┬а ┬а <h1 id="userName" class="text-white text-lg font-bold mt-3">р╕Бр╕│р╕ер╕▒р╕Зр╣Вр╕лр╕ер╕Ф...</h1>
┬а ┬а ┬а ┬а ┬а ┬а <div class="flex items-center gap-2 mt-1">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span class="text-blue-100 text-xs">р╕гр╕░р╕Ър╕Ър╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ</span>
┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а </div>
┬а ┬а </div>

┬а ┬а <div class="px-5 -mt-8 flex-grow pb-24 z-20">
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а <div class="glass-card p-6 mb-5">
┬а ┬а ┬а ┬а ┬а ┬а <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4 ml-1">р╣Ар╕бр╕Щр╕╣р╕ер╕Зр╣Ар╕зр╕ер╕▓</h2>
┬а ┬а ┬а ┬а ┬а ┬а <div class="grid grid-cols-2 gap-3">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button onclick="handleAction('р╣Ар╕Вр╣Йр╕▓р╕Зр╕▓р╕Щ')" class="btn-press bg-emerald-50 border border-emerald-100 p-4 rounded-xl flex flex-col items-center justify-center gap-2">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="w-10 h-10 bg-emerald-500 text-white rounded-full flex items-center justify-center text-lg shadow-md shadow-emerald-200">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <i class="fas fa-sign-in-alt"></i>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span class="text-emerald-700 font-medium text-sm">р╣Ар╕Вр╣Йр╕▓р╕Зр╕▓р╕Щ</span>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </button>

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button onclick="handleAction('р╕Юр╕▒р╕Бр╣Ар╕Ър╕гр╕Д')" class="btn-press bg-amber-50 border border-amber-100 p-4 rounded-xl flex flex-col items-center justify-center gap-2">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="w-10 h-10 bg-amber-400 text-white rounded-full flex items-center justify-center text-lg shadow-md shadow-amber-200">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <i class="fas fa-utensils"></i>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span class="text-amber-700 font-medium text-sm">р╕Юр╕▒р╕Бр╣Ар╕Ър╕гр╕Д</span>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </button>

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button onclick="handleAction('р╕Бр╕ер╕▒р╕Ър╕бр╕▓р╕Чр╕│р╕Зр╕▓р╕Щ')" class="btn-press bg-blue-50 border border-blue-100 p-4 rounded-xl flex flex-col items-center justify-center gap-2">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center text-lg shadow-md shadow-blue-200">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <i class="fas fa-undo"></i>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span class="text-blue-700 font-medium text-sm">р╕Бр╕ер╕▒р╕Ър╕Чр╕│</span>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </button>

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button onclick="openCheckoutModal()" class="btn-press bg-rose-50 border border-rose-100 p-4 rounded-xl flex flex-col items-center justify-center gap-2">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="w-10 h-10 bg-rose-500 text-white rounded-full flex items-center justify-center text-lg shadow-md shadow-rose-200">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <i class="fas fa-sign-out-alt"></i>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span class="text-rose-700 font-medium text-sm">р╕нр╕нр╕Бр╕Зр╕▓р╕Щ</span>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </button>

┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а </div>

┬а ┬а ┬а ┬а <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
┬а ┬а ┬а ┬а ┬а ┬а <div class="flex justify-between items-center mb-4">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <i class="fas fa-history text-indigo-500"></i> р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕зр╕▒р╕Щр╕Щр╕╡р╣Й
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </h3>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button onclick="fetchHistory()" class="text-xs text-indigo-500 hover:underline">р╕гр╕╡р╣Ар╕Яр╕гр╕К</button>
┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а <div id="historyList" class="space-y-2">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="text-center py-4 text-slate-400 text-xs">р╕Бр╕│р╕ер╕▒р╕Зр╣Вр╕лр╕ер╕Ф...</div>
┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а </div>
┬а ┬а </div>

┬а ┬а <div id="loadingOverlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-50 hidden flex-col items-center justify-center">
┬а ┬а ┬а ┬а <div class="loader mb-3"></div>
┬а ┬а ┬а ┬а <p class="text-slate-600 text-sm font-medium animate-pulse">р╕Бр╕│р╕ер╕▒р╕Зр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е...</p>
┬а ┬а </div>

┬а ┬а <div id="checkoutModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden items-center justify-center px-4 transition-opacity duration-300 opacity-0">
┬а ┬а ┬а ┬а <div class="bg-white w-full max-w-xs rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300">
┬а ┬а ┬а ┬а ┬а ┬а <div class="bg-rose-500 p-4 text-white text-center">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <h3 class="font-bold">р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Бр╕▓р╕гр╕нр╕нр╕Бр╕Зр╕▓р╕Щ</h3>
┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а <div class="p-5">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <p class="text-xs text-slate-500 mb-2">р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Зр╕▓р╕Щр╕Чр╕╡р╣Ир╕Чр╕│р╕зр╕▒р╕Щр╕Щр╕╡р╣Й:</p>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <textarea id="workDescInput" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-rose-400 focus:outline-none h-24 resize-none" placeholder="р╣Ар╕Кр╣Ир╕Щ р╣Ар╕Др╕ер╕╡р╕вр╕гр╣Мр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Ър╕▒р╕Нр╕Кр╕╡, р╕Ыр╕гр╕░р╕Кр╕╕р╕бр╕ер╕╣р╕Бр╕Др╣Йр╕▓"></textarea>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="flex gap-2 mt-4">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button onclick="closeCheckoutModal()" class="flex-1 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium">р╕вр╕Бр╣Ар╕ер╕┤р╕Б</button>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button onclick="confirmCheckout()" class="flex-1 py-2 bg-rose-500 text-white rounded-lg text-sm font-medium shadow-lg shadow-rose-200">р╕вр╕╖р╕Щр╕вр╕▒р╕Щ</button>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а </div>
┬а ┬а </div>

┬а ┬а <script>
┬а ┬а ┬а ┬а // тЪая╕ПтЪая╕П р╣Бр╕Бр╣Йр╣Др╕Вр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Хр╕гр╕Зр╕Щр╕╡р╣Й (р╣Гр╕кр╣И URL р╣Гр╕лр╕бр╣Ир╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕Ир╕▓р╕Бр╕Бр╕▓р╕г Deploy р╕ер╣Ир╕▓р╕кр╕╕р╕Ф) тЪая╕ПтЪая╕П
┬а ┬а ┬а ┬а const CONFIG = {
┬а ┬а ┬а ┬а ┬а ┬а LIFF_ID: "2008786300-Zxf736Ka",┬а
┬а ┬а ┬а ┬а ┬а ┬а GAS_URL: "https://script.google.com/macros/s/AKfycbztThBYPFBGw1gKYl6-EsAUSr0z3fQ71S_wcsqWqVCiY3Pq7DAClfBYU0Ec4qWxH3YG9Q/exec"
┬а ┬а ┬а ┬а };

┬а ┬а ┬а ┬а let USER_PROFILE = null;
┬а ┬а ┬а ┬а let OFFICE_LOCATIONS = [];

┬а ┬а ┬а ┬а // --- 1. System Start ---
┬а ┬а ┬а ┬а async function main() {
┬а ┬а ┬а ┬а ┬а ┬а try {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а await liff.init({ liffId: CONFIG.LIFF_ID });
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (!liff.isLoggedIn()) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а liff.login();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return;
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а USER_PROFILE = await liff.getProfile();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а updateUI(USER_PROFILE);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕╣р╣Ир╕Вр╕Щр╕▓р╕Щ
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а await Promise.all([
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а fetchHistory(),
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а fetchOfficeLocations()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ]);

┬а ┬а ┬а ┬а ┬а ┬а } catch (err) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.error(err);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // alert("Error Init: " + err.message); // р╕Ыр╕┤р╕Фр╣Др╕зр╣Йр╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╕кр╕зр╕вр╕Зр╕▓р╕б
┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а function updateUI(profile) {
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('userImage').src = profile.pictureUrl;
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('userName').innerText = profile.displayName;
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('profileSection').classList.remove('opacity-0');
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а // --- 2. Load Office Locations (FIXED CORS) ---
┬а ┬а ┬а ┬а async function fetchOfficeLocations() {
┬а ┬а ┬а ┬а ┬а ┬а try {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // р╕кр╣Ир╕Зр╣Бр╕Ър╕Ъ Simple Request (р╣Др╕бр╣Ир╕бр╕╡ Header JSON)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const response = await fetch(CONFIG.GAS_URL, {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а method: 'POST',
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а body: JSON.stringify({ action: 'get_office_locations' })
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а });
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const result = await response.json();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а OFFICE_LOCATIONS = result.data || [];
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.log("Office Loaded:", OFFICE_LOCATIONS.length);
┬а ┬а ┬а ┬а ┬а ┬а } catch (err) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.warn("Location Load Error:", err);
┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а // --- 3. Main Action Logic ---
┬а ┬а ┬а ┬а async function handleAction(type, note = "-") {
┬а ┬а ┬а ┬а ┬а ┬а toggleLoading(true);
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а try {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // 1. р╕лр╕▓ GPS
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const userLoc = await getGPS();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (userLoc.lat === 0 && userLoc.lng === 0) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а throw new Error("р╣Др╕бр╣Ир╕Юр╕Ър╕кр╕▒р╕Нр╕Нр╕▓р╕У GPS р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕Ыр╕┤р╕Ф Location р╣Гр╕Щр╕бр╕╖р╕нр╕Цр╕╖р╕н");
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // 2. р╣Ар╕Кр╣Зр╕Др╕зр╣Ир╕▓р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕е Office р╕лр╕гр╕╖р╕нр╕вр╕▒р╕З
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (OFFICE_LOCATIONS.length === 0) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а await fetchOfficeLocations();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (OFFICE_LOCATIONS.length === 0) throw new Error("р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕Цр╕▓р╕Щр╕Чр╕╡р╣Ир╕Чр╕│р╕Зр╕▓р╕Щр╣Гр╕Щр╕гр╕░р╕Ър╕Ъ (р╣Вр╕Ыр╕гр╕Фр╕Хр╕┤р╕Фр╕Хр╣Ир╕н Admin)");
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // 3. р╕Др╕│р╕Щр╕зр╕Ур╕гр╕░р╕вр╕░р╕лр╣Ир╕▓р╕Зр╕Бр╕▒р╕Ър╕Чр╕╕р╕Бр╕кр╕▓р╕Вр╕▓
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а let matchedLocation = null;
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а let minDistance = Infinity;

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а OFFICE_LOCATIONS.forEach(office => {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const officeLat = parseFloat(office.lat);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const officeLng = parseFloat(office.lng);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const officeRadius = parseFloat(office.radius) || 500;

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const dist = calculateDistance(userLoc.lat, userLoc.lng, officeLat, officeLng);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (dist <= officeRadius && dist < minDistance) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а minDistance = dist;
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а matchedLocation = office;
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а });

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (!matchedLocation) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а throw new Error(`р╕Др╕╕р╕Ур╕нр╕вр╕╣р╣Ир╕Щр╕нр╕Бр╕Юр╕╖р╣Йр╕Щр╕Чр╕╡р╣Ир╕Чр╕│р╕Зр╕▓р╕Щ (р╕лр╣Ир╕▓р╕Зр╕Ир╕╕р╕Фр╕Чр╕╡р╣Ир╣Гр╕Бр╕ер╣Йр╕кр╕╕р╕Ф ${Math.round(minDistance)} р╕б.)`);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // 4. р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Ы GAS (FIXED CORS)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const payload = {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а action: 'submit_checkin',
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а userId: USER_PROFILE.userId,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayName: USER_PROFILE.displayName,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а pictureUrl: USER_PROFILE.pictureUrl,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а type: type,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а lat: userLoc.lat,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а lng: userLoc.lng,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а note: note,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а locationName: matchedLocation.name,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а distance: Math.round(minDistance)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а };

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а await sendToGAS(payload);

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а toggleLoading(false);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а alert(`тЬЕ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б "${type}" р╕кр╕│р╣Ар╕гр╣Зр╕И!\nЁЯУН ${matchedLocation.name}`);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а fetchHistory(); // р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Чр╕▒р╕Щр╕Чр╕╡

┬а ┬а ┬а ┬а ┬а ┬а } catch (err) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а toggleLoading(false);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а alert("тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф: " + err.message);
┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а // --- 4. History (FIXED CORS) ---
┬а ┬а ┬а ┬а async function fetchHistory() {
┬а ┬а ┬а ┬а ┬а ┬а const list = document.getElementById('historyList');
┬а ┬а ┬а ┬а ┬а ┬а try {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const response = await fetch(CONFIG.GAS_URL, {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а method: 'POST',
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а body: JSON.stringify({ action: 'get_today_history', userId: USER_PROFILE.userId })
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а });
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const res = await response.json();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а renderHistory(res.data);
┬а ┬а ┬а ┬а ┬а ┬а } catch (err) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.error(err);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а list.innerHTML = `<div class="text-center text-xs text-rose-400">р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕ер╣Йр╕бр╣Ар╕лр╕ер╕з</div>`;
┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а function renderHistory(logs) {
┬а ┬а ┬а ┬а ┬а ┬а const list = document.getElementById('historyList');
┬а ┬а ┬а ┬а ┬а ┬а list.innerHTML = "";
┬а ┬а ┬а ┬а ┬а ┬а if (!logs || logs.length === 0) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а list.innerHTML = `<div class="text-center py-4 text-slate-300 text-xs">р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕зр╕▒р╕Щр╕Щр╕╡р╣Й</div>`;
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return;
┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а ┬а ┬а logs.forEach(log => {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а let color = "bg-slate-500";
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if(log.action.includes("р╣Ар╕Вр╣Йр╕▓")) color = "bg-emerald-500";
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а else if(log.action.includes("р╕нр╕нр╕Б")) color = "bg-rose-500";
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а else if(log.action.includes("р╕Юр╕▒р╕Б")) color = "bg-amber-400";
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а else color = "bg-blue-500";

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а list.innerHTML += `
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="flex items-center gap-3">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="w-2 h-2 rounded-full ${color}"></div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span class="text-sm text-slate-600 font-medium">${log.action}</span>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <span class="text-xs font-mono text-slate-400">${log.time} р╕Щ.</span>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>`;
┬а ┬а ┬а ┬а ┬а ┬а });
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а // --- 5. Helpers ---
┬а ┬а ┬а ┬а function calculateDistance(lat1, lon1, lat2, lon2) {
┬а ┬а ┬а ┬а ┬а ┬а const R = 6371e3;
┬а ┬а ┬а ┬а ┬а ┬а const ╧Ж1 = lat1 * Math.PI/180;
┬а ┬а ┬а ┬а ┬а ┬а const ╧Ж2 = lat2 * Math.PI/180;
┬а ┬а ┬а ┬а ┬а ┬а const ╬Ф╧Ж = (lat2-lat1) * Math.PI/180;
┬а ┬а ┬а ┬а ┬а ┬а const ╬Ф╬╗ = (lon2-lon1) * Math.PI/180;
┬а ┬а ┬а ┬а ┬а ┬а const a = Math.sin(╬Ф╧Ж/2) * Math.sin(╬Ф╧Ж/2) + Math.cos(╧Ж1) * Math.cos(╧Ж2) * Math.sin(╬Ф╬╗/2) * Math.sin(╬Ф╬╗/2);
┬а ┬а ┬а ┬а ┬а ┬а const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
┬а ┬а ┬а ┬а ┬а ┬а return R * c;
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а function getGPS() {
┬а ┬а ┬а ┬а ┬а ┬а return new Promise((resolve) => {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if(!navigator.geolocation) resolve({lat:0, lng:0});
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а navigator.geolocation.getCurrentPosition(
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а () => resolve({ lat:0, lng:0 }),
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а );
┬а ┬а ┬а ┬а ┬а ┬а });
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а async function sendToGAS(payload) {
┬а ┬а ┬а ┬а ┬а ┬а // р╕кр╣Ир╕Зр╣Бр╕Ър╕Ър╣Др╕бр╣Ир╕бр╕╡ Header р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕ер╕╡р╣Ир╕вр╕З Preflight Options Request
┬а ┬а ┬а ┬а ┬а ┬а return fetch(CONFIG.GAS_URL, {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а method: 'POST',
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а body: JSON.stringify(payload)
┬а ┬а ┬а ┬а ┬а ┬а });
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а function toggleLoading(show) {
┬а ┬а ┬а ┬а ┬а ┬а const el = document.getElementById('loadingOverlay');
┬а ┬а ┬а ┬а ┬а ┬а if(show) { el.classList.remove('hidden'); el.classList.add('flex'); }
┬а ┬а ┬а ┬а ┬а ┬а else { el.classList.add('hidden'); el.classList.remove('flex'); }
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а // Modal Logic
┬а ┬а ┬а ┬а const modal = document.getElementById('checkoutModal');
┬а ┬а ┬а ┬а const modalBox = modal.querySelector('div');
┬а ┬а ┬а ┬а function openCheckoutModal() {
┬а ┬а ┬а ┬а ┬а ┬а modal.classList.remove('hidden'); modal.classList.add('flex');
┬а ┬а ┬а ┬а ┬а ┬а setTimeout(() => { modal.classList.remove('opacity-0'); modalBox.classList.remove('scale-95'); }, 10);
┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а function closeCheckoutModal() {
┬а ┬а ┬а ┬а ┬а ┬а modal.classList.add('opacity-0'); modalBox.classList.add('scale-95');
┬а ┬а ┬а ┬а ┬а ┬а setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а function confirmCheckout() {
┬а ┬а ┬а ┬а ┬а ┬а const note = document.getElementById('workDescInput').value.trim();
┬а ┬а ┬а ┬а ┬а ┬а if(!note) { alert("р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕░р╕Ър╕╕р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Зр╕▓р╕Щ"); return; }
┬а ┬а ┬а ┬а ┬а ┬а closeCheckoutModal();
┬а ┬а ┬а ┬а ┬а ┬а handleAction('р╕нр╕нр╕Бр╕Зр╕▓р╕Щ', note);
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('workDescInput').value = "";
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а main();
┬а ┬а </script>
</body>
</html>
